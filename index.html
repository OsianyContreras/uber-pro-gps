<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uber Pro GPS</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
/* (mantengo tu estilo exactamente como estaba) */
body{
  margin:0;
  padding:0;
  font-family:-apple-system, BlinkMacSystemFont, system-ui;
  background:radial-gradient(circle at top,#020617,#000);
  color:#fff;
  display:flex;
  justify-content:center;
}

.card{
  width:100%;
  max-width:420px;
  margin:16px;
  padding:18px;
  border-radius:20px;
  background:#020617;
  position:relative;
  box-shadow:0 0 0 1px rgba(148,163,184,.15),
             0 30px 60px rgba(0,0,0,.7);
  animation:fadeIn .8s ease;
}

.card::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:22px;
  background:linear-gradient(120deg,#22c55e,#38bdf8,#22c55e);
  z-index:-1;
  animation:borderGlow 6s linear infinite;
}

@keyframes borderGlow{
  0%{filter:hue-rotate(0deg)}
  100%{filter:hue-rotate(360deg)}
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1}
}

h1{
  text-align:center;
  font-size:20px;
  margin-bottom:10px;
}

input[type=file]{
  width:100%;
  margin-top:10px;
}

img{
  width:100%;
  max-height:35vh;
  object-fit:contain;
  border-radius:14px;
  margin-top:12px;
  background:#000;
}

button{
  width:100%;
  padding:15px;
  margin-top:12px;
  border-radius:14px;
  border:none;
  font-size:16px;
  font-weight:600;
  background:#22c55e;
  color:#000;
}

button.secondary{background:#38bdf8}
button.gray{background:#64748b;color:#fff}
button:disabled{opacity:.4}

.status{
  margin-top:10px;
  font-size:14px;
  color:#94a3b8;
}

.coords{
  margin-top:10px;
  padding:10px;
  border-radius:12px;
  background:#020617;
  border:1px solid rgba(148,163,184,.15);
}

.coords b{
  color:#22c55e;
  text-shadow:0 0 8px rgba(34,197,94,.6);
}

.highlight{
  background:rgba(34,197,94,.15);
  padding:2px 6px;
  border-radius:6px;
}

.history{
  margin-top:12px;
  font-size:14px;
  color:#94a3b8;
}

#debug{
  margin-top:12px;
  font-size:12px;
  background:#000;
  padding:8px;
  border-radius:10px;
  max-height:120px;
  overflow:auto;
}

.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%) translateY(20px);
  background:#22c55e;
  color:#000;
  padding:10px 16px;
  border-radius:14px;
  font-size:14px;
  font-weight:600;
  opacity:0;
  pointer-events:none;
  transition:all .3s ease;
  box-shadow:0 10px 30px rgba(0,0,0,.6);
}
.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}
</style>
</head>

<body>
<div class="card">
<h1>ðŸš— Uber Pro GPS</h1>

<input type="file" id="fileInput" accept="image/*">
<img id="preview">

<button id="analyzeBtn">Analizar Trayecto</button>

<div class="status" id="status">Estado: esperando imagen</div>

<div class="coords" id="coords">
Latitud: â€”<br>Longitud: â€”<br>App: â€”
</div>

<button id="copyBtn" class="gray" disabled>ðŸ“‹ Copiar de nuevo</button>
<!-- Reemplazamos Navegar PRO por Nueva Consulta -->
<button id="newQueryBtn" class="secondary" style="display:none;">Nueva Consulta</button>

<div class="history" id="history"></div>
<div id="debug"><b>DEBUG:</b><br></div>
</div>

<div id="toast" class="toast">ðŸ“‹ Coordenadas copiadas</div>

<script>
/* ================ Utils / DOM ================ */
const debug = msg => { document.getElementById("debug").innerHTML += msg + "<br>"; };
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const analyzeBtn = document.getElementById('analyzeBtn');
const copyBtn = document.getElementById('copyBtn');
const newQueryBtn = document.getElementById('newQueryBtn');
const status = document.getElementById('status');
const coordsBox = document.getElementById('coords');
let lat = null, lng = null, appDetectada = "â€”";

/* Toast + vibration */
function showToast(){
  const t = document.getElementById('toast');
  t.classList.add('show');
  if(navigator.vibrate) navigator.vibrate(40);
  setTimeout(()=> t.classList.remove('show'), 2000);
}

/* Preview */
fileInput.onchange = e => {
  const f = e.target.files[0];
  if(!f) return;
  preview.src = URL.createObjectURL(f);
  status.textContent = "Estado: Imagen preparada para OCR";
  debug("Imagen cargada");
  // reset UI in case a previous run left stuff
  copyBtn.disabled = true;
  newQueryBtn.style.display = "none";
};

/* OCR and parse */
analyzeBtn.onclick = async () => {
  if(!preview.src){ status.textContent = "Sube una imagen primero"; return; }
  status.textContent = "Estado: OCR en procesoâ€¦";
  try{
    const res = await Tesseract.recognize(preview.src, "eng");
    const text = res.data.text || "";
    debug("Texto OCR capturado");

    if(/uber/i.test(text)) appDetectada = "Uber";
    if(/didi/i.test(text)) appDetectada = "Didi";

    const m = text.match(/(-?\d{1,2}\.\d+)[,\s]+(-?\d{1,3}\.\d+)/);
    if(!m) throw new Error("Sin coordenadas");

    lat = m[1];
    lng = m[2];

    coordsBox.innerHTML = `
      Latitud: <span class="highlight"><b>${lat}</b></span><br>
      Longitud: <span class="highlight"><b>${lng}</b></span><br>
      App: <b>${appDetectada}</b>
    `;

    // copy to clipboard exact format lat,lng
    await navigator.clipboard.writeText(`${lat},${lng}`);
    debug("Coordenadas copiadas al portapapeles: " + `${lat},${lng}`);
    showToast();

    // enable copy again and show new query button
    copyBtn.disabled = false;
    newQueryBtn.style.display = "block";

    status.textContent = "Estado: Coordenadas detectadas";

    // === Intentar abrir Sygic automÃ¡ticamente ===
    await tryOpenSygicAuto(lat, lng);
    // === fin intento Sygic ===

    // save history
    saveHistory(`${lat},${lng} (${appDetectada})`);
  }catch(err){
    console.error(err);
    status.textContent = "Error al analizar imagen";
    debug("ERROR OCR: " + (err && err.message ? err.message : err));
  }
};

/* Copy again button */
copyBtn.onclick = async () => {
  if(!lat || !lng) return;
  await navigator.clipboard.writeText(`${lat},${lng}`);
  debug("Coordenadas copiadas (manual): " + `${lat},${lng}`);
  showToast();
};

/* New Query button (limpia todo) */
newQueryBtn.onclick = () => {
  // Reset UI
  fileInput.value = "";
  preview.src = "";
  coordsBox.innerHTML = `Latitud: â€”<br>Longitud: â€”<br>App: â€”`;
  copyBtn.disabled = true;
  newQueryBtn.style.display = "none";
  status.textContent = "Estado: esperando imagen";
  lat = null; lng = null; appDetectada = "â€”";
  debug("Nueva consulta iniciada (limpieza)");
};

/* History */
function saveHistory(value){
  const arr = JSON.parse(localStorage.getItem('historial') || '[]');
  arr.unshift({ when: new Date().toLocaleString(), value });
  localStorage.setItem('historial', JSON.stringify(arr.slice(0,10)));
  renderHistory();
}
function renderHistory(){
  const arr = JSON.parse(localStorage.getItem('historial') || '[]');
  const box = document.getElementById('history');
  box.innerHTML = "<b>Historial:</b><br>" + arr.map(x => `â€¢ ${x.when} â€” ${x.value}`).join("<br>");
}
renderHistory();

/* ================ Sygic auto-open logic (robust attempt) ================ */
/*
  Strategy:
  - Must be triggered by user gesture (we call it right after analyze, which is a user gesture)
  - Try multiple schemes in sequence.
  - Use page visibility (document.hidden) to detect whether the browser lost focus (app opened).
  - If after timeout no visibility change, assume not installed and fallback to Google Maps.
  - This method is the best we can do from web; in native Capacitor it's more reliable.
*/
async function tryOpenSygicAuto(lat, lng){
  const schemes = [
    `com.sygic.aura://coordinate|${lat},${lng}`,
    `sygic://coordinate|${lat},${lng}`
  ];
  const google = `https://maps.google.com/?q=${lat},${lng}`;

  for(const url of schemes){
    try{
      const opened = await tryOpenUrlDetect(url, 1400);
      if(opened){
        debug("Sygic abierto via scheme: " + url);
        return true;
      } else {
        debug("Scheme no abriÃ³ (probando siguiente): " + url);
      }
    }catch(e){
      console.warn("Error al intentar scheme", e);
    }
  }

  // fallback: open Google Maps in a new tab
  debug("Sygic no detectado / no abriÃ³. Abriendo Google Maps como fallback");
  window.open(google, '_blank');
  return false;
}

function tryOpenUrlDetect(url, timeout = 1200){
  return new Promise(resolve => {
    let resolved = false;
    const start = Date.now();

    // visibility change handler
    function onVis(){
      // if page becomes hidden quickly, assume the app opened
      if(document.hidden){
        cleanup(true);
      }
    }

    // cleanup helper
    function cleanup(result){
      if(resolved) return;
      resolved = true;
      document.removeEventListener('visibilitychange', onVis);
      // remove blur listener as well
      window.removeEventListener('pagehide', onPageHide);
      clearTimeout(timer);
      resolve(result);
    }

    function onPageHide(){ cleanup(true); }

    document.addEventListener('visibilitychange', onVis);
    window.addEventListener('pagehide', onPageHide);

    // create anchor and click it (user gesture context)
    try{
      const a = document.createElement('a');
      a.href = url;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }catch(e){
      console.warn('anchor click failed', e);
    }

    // fallback timer: if not hidden within timeout => not opened
    const timer = setTimeout(()=> cleanup(false), timeout);
  });
}
</script>
</body>
</html>
