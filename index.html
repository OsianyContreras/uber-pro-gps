<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Uber Pro GPS Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tesseract para OCR local (fallback si no hay apiKey o si falla la red) -->
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

    <style>
        /* --- Mantengo exactamente tu estilo original --- */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;400;700;900&display=swap');

        :root {
            --neon-blue: #00d2ff;
            --deep-blue: #0072ff;
        }

        body {
            background-color: #050505;
            color: #fff;
            font-family: 'Inter', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .brand-title {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 2.5rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #000;
            -webkit-text-stroke: 1.5px var(--neon-blue);
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.7),
                         0 0 20px rgba(0, 210, 255, 0.3);
            position: relative;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .neon-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 90vh;
            background: #0a0a0a;
            border-radius: 40px;
            padding: 3px;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0, 114, 255, 0.3);
            margin: 10px;
        }

        .neon-container::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: conic-gradient(transparent, var(--neon-blue), var(--deep-blue), transparent 40%);
            animation: rotate 6s linear infinite;
        }

        @keyframes rotate { 100% { transform: rotate(360deg); } }

        .glass-panel {
            position: relative;
            z-index: 1;
            background: rgba(10, 10, 10, 0.95);
            width: 100%; height: 100%;
            border-radius: 37px;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .ios-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 20px;
            transition: all 0.3s ease;
        }

        #dropzone {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            max-height: 50vh;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
            color: #000;
            font-weight: 900;
            border-radius: 18px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            flex-shrink: 0;
            border: none;
            width: 100%;
            padding: 18px;
            opacity: 0.2;
            transform: scale(0.95);
        }

        .btn-analyze.active {
            opacity: 1;
            transform: scale(1);
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.4);
        }

        .btn-copy {
            background: rgba(0, 210, 255, 0.15);
            color: var(--neon-blue);
            font-size: 10px;
            font-weight: 900;
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid rgba(0, 210, 255, 0.3);
            text-transform: uppercase;
        }

        .preview-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 20px;
            display: none;
        }

        /* Result panel same look as your original UI */
        #ui-results { display: none; margin-top: 12px; }
        #ui-results .ios-card { margin-bottom: 8px; }
        code { color: #00d2ff; font-family: monospace; font-size: 13px; }
        .small { font-size: 11px; color: #bcd; }
    </style>
</head>
<body>

    <div class="neon-container">
        <div class="glass-panel">
            <div class="text-center mb-6 flex-shrink-0">
                <h1 class="brand-title">UBER PRO</h1>
                <div class="flex items-center justify-center space-x-2 opacity-60">
                    <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
                    <span class="text-[10px] font-bold tracking-[0.3em] uppercase">Deep Scan GPS</span>
                </div>
            </div>

            <div id="ui-main" class="flex-1 flex flex-col min-h-0">
                <div id="dropzone" class="ios-card" title="Toca para seleccionar imagen">
                    <input id="file-input" type="file" accept="image/*" hidden>
                    <div id="upload-icon" class="text-center">
                        <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/20">
                            <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        </div>
                        <p id="upload-text" class="text-xs font-black text-white/40 uppercase tracking-widest">Cargar Captura</p>
                    </div>
                    <img id="image-preview" class="preview-img" alt="preview">
                </div>

                <button id="analyze-trigger" class="btn-analyze" title="Analizar la captura">
                    Analizar Trayecto ✨
                </button>

                <!-- Result area (hidden until analysis completes) -->
                <div id="ui-results">
                    <div class="ios-card bg-gradient-to-br from-blue-600/20 to-transparent">
                        <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Ganancia</p>
                        <h2 id="res-price" class="text-4xl font-black text-white tracking-tighter">--</h2>
                    </div>

                    <div class="ios-card">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1 pr-4">
                                <span class="text-[9px] font-black text-blue-500 uppercase">Origen</span>
                                <p id="res-pickup-addr" class="text-[11px] font-bold text-white/90 mt-1 small"></p>
                            </div>
                            <button onclick="copyToClipboard('res-pickup-gps')" class="btn-copy">Copiar</button>
                        </div>
                        <div class="bg-black/50 p-2 rounded-xl border border-white/5 text-center">
                            <code id="res-pickup-gps">0.000000,0.000000</code>
                        </div>
                    </div>

                    <div class="ios-card">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1 pr-4">
                                <span class="text-[9px] font-black text-blue-500 uppercase">Destino</span>
                                <p id="res-dropoff-addr" class="text-[11px] font-bold text-white/90 mt-1 small"></p>
                            </div>
                            <button onclick="copyToClipboard('res-dropoff-gps')" class="btn-copy">Copiar</button>
                        </div>
                        <div class="bg-black/50 p-2 rounded-xl border border-white/5 text-center">
                            <code id="res-dropoff-gps">0.000000,0.000000</code>
                        </div>
                    </div>

                    <button id="btn-restart" class="w-full py-4 text-[10px] font-bold text-white/20 uppercase tracking-widest hover:text-white transition-colors">Nueva Captura</button>
                </div>

            </div>

        </div>
    </div>

<script>
/* ---------------------------
  Variables (NO tocar diseño)
   - Si deseas usar la API generativa, coloca tu key aquí.
---------------------------- */
const apiKey = ""; // <--- pon aquí tu Google API key si quieres usar el endpoint generativo

/* Elementos */
const fileInput = document.getElementById('file-input');
const dropzone = document.getElementById('dropzone');
const imgPreview = document.getElementById('image-preview');
const uploadIcon = document.getElementById('upload-icon');
const uploadText = document.getElementById('upload-text');
const analyzeBtn = document.getElementById('analyze-trigger');
const uiResults = document.getElementById('ui-results');
const btnRestart = document.getElementById('btn-restart');

let base64String = "";

/* --- FIX: abrir selector al tocar el dropzone --- */
dropzone.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        imgPreview.src = ev.target.result;
        imgPreview.style.display = 'block';
        uploadIcon.style.display = 'none';
        base64String = ev.target.result.split(',')[1];
        analyzeBtn.classList.add('active');
    };
    reader.readAsDataURL(file);
});

/* copy to clipboard helper */
function copyToClipboard(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const text = el.innerText.trim();
    if (!text) return;
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    // small toast
    const toast = document.createElement('div');
    toast.innerText = 'COORDENADAS COPIADAS';
    toast.style = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#0072ff;color:#fff;padding:8px 16px;border-radius:20px;font-weight:700;z-index:9999';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(),1200);
}

/* --- Normalize/validate coords (keeps exactly lat,long with 6 decimals) --- */
function roundToSix(n){ return Math.round(n*1e6)/1e6; }
function isValidLat(lat){ return typeof lat==='number' && lat>=-90 && lat<=90; }
function isValidLng(lng){ return typeof lng==='number' && lng>=-180 && lng<=180; }

function normalizeCoords(input){
    if (!input && input !== 0) return "0.000000,0.000000";
    if (Array.isArray(input) && input.length>=2){
        let a=Number(input[0]), b=Number(input[1]);
        if (!isFinite(a)||!isFinite(b)) return "0.000000,0.000000";
        if (!isValidLat(a) && isValidLat(b) && isValidLng(a) && isValidLng(b)) [a,b]=[b,a];
        if (isValidLat(a) && isValidLng(b)) return `${roundToSix(a).toFixed(6)},${roundToSix(b).toFixed(6)}`;
        return "0.000000,0.000000";
    }
    const nums = (''+input).match(/-?\d+(\.\d+)?/g);
    if (!nums || nums.length < 2) return "0.000000,0.000000";
    let n1=Number(nums[0]), n2=Number(nums[1]);
    if (!isFinite(n1) || !isFinite(n2)) return "0.000000,0.000000";
    if (!isValidLat(n1) && isValidLat(n2) && isValidLng(n1) && isValidLng(n2)) [n1,n2]=[n2,n1];
    if (isValidLat(n1) && isValidLng(n2)) return `${roundToSix(n1).toFixed(6)},${roundToSix(n2).toFixed(6)}`;
    if (nums.length >= 3){
        let n3=Number(nums[2]);
        if (isValidLat(n1) && isValidLng(n3)) return `${roundToSix(n1).toFixed(6)},${roundToSix(n3).toFixed(6)}`;
    }
    return "0.000000,0.000000";
}

/* --- Parse text for data (price, addresses, coordinate pairs) --- */
function parseTextForData(text){
    const out = { precio:null, recogida:null, destino:null, gps_recogida:null, gps_destino:null };
    if (!text) return out;

    // price
    const priceMatch = text.match(/\$?\s?(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{1,2})?)/);
    if (priceMatch) out.precio = priceMatch[0].replace(/\s+/g,'').replace(',', '.');

    // extract decimal numbers (candidates for coords)
    const nums = text.match(/-?\d+\.\d+/g) || [];
    const pairs = [];
    for (let i=0;i+1<nums.length;i+=2) pairs.push([nums[i], nums[i+1]]);
    if (pairs.length >= 1) out.gps_recogida = normalizeCoords(pairs[0]);
    if (pairs.length >= 2) out.gps_destino = normalizeCoords(pairs[1]);

    // addresses: lines that contain words común
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>3);
    const addrCandidates = lines.filter(l => /calle|av\.|avenida|col\.|colonia|no\.|n\.|numero|#|street|st\.|ave\.|terminal|aeropuerto|airport/i.test(l));
    if (addrCandidates.length>0){
        out.recogida = addrCandidates[0];
        if (addrCandidates.length>1) out.destino = addrCandidates[1];
    } else {
        // fallback: first two non-numeric lines
        const textLines = lines.filter(l => !/^\d+$/.test(l));
        if (textLines.length>0) out.recogida = textLines[0];
        if (textLines.length>1) out.destino = textLines[1];
    }
    return out;
}

/* --- OCR helper using Tesseract.js (returns recognized text) --- */
async function runOCRFromImage(imgEl) {
    try {
        // Tesseract recognizes from a URL or data URI (we use the preview.src)
        const result = await Tesseract.recognize(imgEl.src, 'spa+eng', { logger: m => {/* optional progress */} });
        return result.data && result.data.text ? result.data.text : '';
    } catch (err) {
        console.error('OCR error', err);
        return '';
    }
}

/* --- ANALYZE BUTTON FLOW --- */
analyzeBtn.addEventListener('click', async () => {
    if (!base64String) {
        alert('Selecciona una imagen primero.');
        return;
    }

    // UI feedback
    analyzeBtn.disabled = true;
    const originalText = analyzeBtn.innerText;
    analyzeBtn.innerText = 'Analizando...';

    let final = { precio: null, recogida: null, destino: null, gps_recogida: "0.000000,0.000000", gps_destino: "0.000000,0.000000" };

    // 1) If apiKey provided, try generative endpoint (best-effort)
    if (apiKey && apiKey.trim() !== "") {
        try {
            const prompt = `Analiza detalladamente esta captura de Uber.
REGLAS:
1) Extrae precio, origen (recogida) y destino con texto exacto.
2) Devuelve coordenadas GPS en formato lat,long con 6 decimales.
3) Responde SOLO en JSON:
{"precio":"...","recogida":"...","destino":"...","gps_recogida":"lat,long","gps_destino":"lat,long"}`;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/png", data: base64String } }
                        ]
                    }],
                    generationConfig: { responseMimeType: "application/json", temperature: 0.0 }
                })
            });

            const json = await res.json();
            if (json && json.candidates && json.candidates[0] && json.candidates[0].content && json.candidates[0].content.parts && json.candidates[0].content.parts[0] && json.candidates[0].content.parts[0].text) {
                try {
                    const parsed = JSON.parse(json.candidates[0].content.parts[0].text);
                    final.precio = parsed.precio || final.precio;
                    final.recogida = parsed.recogida || final.recogida;
                    final.destino = parsed.destino || final.destino;
                    final.gps_recogida = normalizeCoords(parsed.gps_recogida || final.gps_recogida);
                    final.gps_destino = normalizeCoords(parsed.gps_destino || final.gps_destino);
                } catch (eParse) {
                    console.warn('No JSON from model, will fallback to OCR local.', eParse);
                }
            } else {
                console.warn('Generative API did not return expected structure; falling back to OCR.');
            }
        } catch (err) {
            console.warn('Generative API error (fallback to local OCR):', err);
        }
    }

    // 2) If still not found, or no apiKey, use local OCR
    if ((!final.gps_recogida || final.gps_recogida === "0.000000,0.000000") || (!final.gps_destino || final.gps_destino === "0.000000,0.000000") || !final.recogida || !final.destino) {
        // Run OCR locally
        try {
            const ocrText = await runOCRFromImage(imgPreview);
            const parsed = parseTextForData(ocrText);
            // merge if fields missing
            final.precio = final.precio || parsed.precio;
            final.recogida = final.recogida || parsed.recogida;
            final.destino = final.destino || parsed.destino;
            final.gps_recogida = (final.gps_recogida && final.gps_recogida !== "0.000000,0.000000") ? final.gps_recogida : (parsed.gps_recogida || final.gps_recogida);
            final.gps_destino = (final.gps_destino && final.gps_destino !== "0.000000,0.000000") ? final.gps_destino : (parsed.gps_destino || final.gps_destino);
        } catch (e) {
            console.error('OCR local failed:', e);
        }
    }

    // Display results in UI
    document.getElementById('res-price').innerText = final.precio || '--';
    document.getElementById('res-pickup-addr').innerText = final.recogida || 'N/A';
    document.getElementById('res-dropoff-addr').innerText = final.destino || 'N/A';
    document.getElementById('res-pickup-gps').innerText = final.gps_recogida || '0.000000,0.000000';
    document.getElementById('res-dropoff-gps').innerText = final.gps_destino || '0.000000,0.000000';

    uiResults.style.display = 'block'; // reveal results

    // restore analyze button
    analyzeBtn.disabled = false;
    analyzeBtn.innerText = originalText || 'Analizar Trayecto ✨';

    // small toast if no exact coords found
    if ((final.gps_recogida === "0.000000,0.000000" || final.gps_destino === "0.000000,0.000000")) {
        const toast = document.createElement('div');
        toast.innerText = 'No se detectaron coordenadas exactas automáticamente. Puedes editarlas manualmente.';
        toast.style = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#ff8a00;color:#fff;padding:8px 14px;border-radius:18px;font-weight:700;z-index:9999';
        document.body.appendChild(toast);
        setTimeout(()=>toast.remove(),3500);
    }
});

/* Restart flow */
btnRestart.addEventListener('click', () => {
    base64String = "";
    imgPreview.src = "";
    imgPreview.style.display = "none";
    uploadIcon.style.display = "block";
    analyzeBtn.classList.remove('active');
    uiResults.style.display = 'none';
    document.getElementById('res-price').innerText = '--';
    document.getElementById('res-pickup-addr').innerText = '';
    document.getElementById('res-dropoff-addr').innerText = '';
    document.getElementById('res-pickup-gps').innerText = '0.000000,0.000000';
    document.getElementById('res-dropoff-gps').innerText = '0.000000,0.000000';
});
</script>

</body>
</html>
