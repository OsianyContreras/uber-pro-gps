<script>
/* --- Variables DOM --- */
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const logBox = document.getElementById('log');
const navChooser = document.getElementById('nav-chooser');
const btnSygic = document.getElementById('btn-sygic');
const btnGoogle = document.getElementById('btn-google');

let currentCoords = null;

function log(msg){
  console.log('[UberPro]', msg);
  if(logBox) logBox.innerText = msg;
}

/* --- File input / preview --- */
fileInput.addEventListener('change', e => {
  const f = e.target.files[0];
  if(!f) { log('No hay archivo seleccionado'); return; }
  preview.src = URL.createObjectURL(f);
  log('Imagen cargada. Listo para analizar.');
});

/* --- OCR y detección simple de coords --- */
async function analyzeImage(){
  if(!fileInput.files[0]) { log('Selecciona una imagen antes de analizar'); return; }
  log('Iniciando OCR...');
  try{
    // Tesseract.recognize acepta File directamente
    const res = await Tesseract.recognize(fileInput.files[0], 'eng');
    const text = (res && res.data && res.data.text) ? res.data.text : (res && res.text) ? res.text : '';
    console.log('[OCR TEXT]', text);
    // búsqueda robusta de lat,lon
    const match = text.match(/(-?\d{1,2}\.\d+)\s*,\s*(-?\d{1,3}\.\d+)/);
    if(!match){
      log('OCR terminó: no se encontraron coordenadas en el texto.');
      return;
    }
    currentCoords = `${match[1]},${match[2]}`;
    try { await navigator.clipboard.writeText(currentCoords); log('Coordenadas detectadas y copiadas: ' + currentCoords); }
    catch(e){ log('Coordenas detectadas: ' + currentCoords + ' (pero no se pudo copiar al portapapeles)'); }
    console.log('[coords]', currentCoords);
  }catch(err){
    console.error('[OCR error]', err);
    log('Error al procesar imagen (OCR). Revisa consola.');
  }
}

/* --- Mostrar / ocultar chooser --- */
function showNavChooser(){
  if(!currentCoords){ log('Primero analiza la imagen para obtener coordenadas'); return; }
  if(navChooser) navChooser.style.display = 'flex';
}
function hideNavChooser(){ if(navChooser) navChooser.style.display = 'none'; }

/* --- Abrir Sygic con varios intentos --- */
function openSygicWithFallback(sygicUrl, googleUrl){
  log('Intentando abrir Sygic...');
  console.log('[try] sygicUrl=', sygicUrl);

  // 1) Capacitor App plugin (recomendado en app nativa)
  try{
    if(window.Capacitor && Capacitor.Plugins && Capacitor.Plugins.App && typeof Capacitor.Plugins.App.openUrl === 'function'){
      console.log('[Capacitor] usando App.openUrl');
      Capacitor.Plugins.App.openUrl({ url: sygicUrl }).catch((err)=>{
        console.warn('[Capacitor] openUrl falló, fallback a Google', err);
        window.location.href = googleUrl;
      });
      return;
    }
  }catch(e){ console.warn('Capacitor openUrl attempt threw', e); }

  // 2) Intentar crear <a> y click (funciona en muchos navegadores para schemes)
  try{
    const a = document.createElement('a');
    a.href = sygicUrl;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    // Si la app no abre, redirigimos a Google después de corto timeout
    setTimeout(()=>{ log('Si Sygic no abrió, redirigiendo a Google Maps'); window.location.href = googleUrl; }, 1200);
    return;
  }catch(e){
    console.warn('Anchor method failed', e);
  }

  // 3) iframe fallback (último recurso)
  try{
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = sygicUrl;
    document.body.appendChild(iframe);
    setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch(e){}; window.location.href = googleUrl; }, 1200);
    return;
  }catch(e){
    console.warn('Iframe method failed', e);
  }

  // 4) Fallback final: abrir Google
  log('No fue posible abrir Sygic desde el navegador. Abriendo Google Maps...');
  window.location.href = googleUrl;
}

/* --- Abrir Google directamente --- */
function openGoogle(googleUrl){
  log('Abriendo Google Maps...');
  try{ window.open(googleUrl, '_blank'); }
  catch(e){ window.location.href = googleUrl; }
}

/* --- Botones del chooser --- */
if(btnSygic) btnSygic.addEventListener('click', ()=>{
  hideNavChooser();
  if(!currentCoords){ log('No hay coordenadas para navegar'); return; }
  const sygicUrl = `com.sygic.aura://coordinate|${currentCoords}`;
  const googleUrl = `https://maps.google.com/?q=${currentCoords}`;
  openSygicWithFallback(sygicUrl, googleUrl);
});

if(btnGoogle) btnGoogle.addEventListener('click', ()=>{
  hideNavChooser();
  if(!currentCoords){ log('No hay coordenadas para navegar'); return; }
  const googleUrl = `https://maps.google.com/?q=${currentCoords}`;
  openGoogle(googleUrl);
});

/* --- Expose functions to inline handlers (if used in HTML) --- */
window.analyzeImage = analyzeImage;
window.showNavChooser = showNavChooser;
window.hideNavChooser = hideNavChooser;
</script>
