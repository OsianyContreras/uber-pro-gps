// ============ CONFIGURACI√ìN ============
const CONFIG = {
  TESSERACT_LANG: 'eng',
  COORD_REGEX: /(-?\d{1,2}\.\d+)[,\s\n]+(-?\d{1,3}\.\d+)/g,
  MAX_FILE_SIZE: 5 * 1024 * 1024,
  SUPPORTED_FORMATS: ['image/jpeg', 'image/png', 'image/webp', 'image/bmp']
};

// ============ ESTADO DE LA APLICACI√ìN ============
const AppState = {
  isProcessing: false,
  coordsData: "",
  latitude: 0,
  longitude: 0,
  currentImage: null,
  originalFile: null, // Archivo comprimido
  sygicAppInstalled: false
};

// ============ FUNCIONES DE VALIDACI√ìN ============
function isValidCoordinate(lat, lon) {
  if (isNaN(lat) || isNaN(lon)) return false;
  if (lat < -90 || lat > 90) return false;
  if (lon < -180 || lon > 180) return false;
  return true;
}

function formatCoordinate(value, type) {
  const rounded = Math.abs(value).toFixed(6);
  const direction = type === 'lat' 
    ? (value >= 0 ? 'N' : 'S')
    : (value >= 0 ? 'E' : 'W');
  return `${rounded}¬∞ ${direction}`;
}

// ============ COMPRESI√ìN DE IM√ÅGENES ============
async function compressImage(file) {
  return new Promise((resolve, reject) => {
    console.log('Comprimiendo imagen... Tama√±o original:', (file.size / 1024).toFixed(2), 'KB');
    
    const MAX_WIDTH = 1200;
    const MAX_HEIGHT = 1200;
    const QUALITY = 0.7;
    
    const reader = new FileReader();
    reader.readAsDataURL(file);
    
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > height) {
          if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
          }
        } else {
          if (height > MAX_HEIGHT) {
            width *= MAX_HEIGHT / height;
            height = MAX_HEIGHT;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob(
          (blob) => {
            console.log('Imagen comprimida. Tama√±o final:', (blob.size / 1024).toFixed(2), 'KB');
            const compressedFile = new File([blob], file.name, {
              type: 'image/jpeg',
              lastModified: Date.now()
            });
            resolve(compressedFile);
          },
          'image/jpeg',
          QUALITY
        );
      };
      
      img.onerror = reject;
    };
    
    reader.onerror = reject;
  });
}

// ============ SYGIC MEJORADO ============
async function openInSygic() {
  if (!AppState.coordsData) {
    showToast('No hay coordenadas disponibles', 'error');
    return;
  }
  
  showToast('Copiando coordenadas...', 'info');
  playSound(2000);
  
  // Copiar coordenadas al portapapeles
  try {
    await navigator.clipboard.writeText(AppState.coordsData);
  } catch (err) {
    // Fallback para navegadores antiguos
    const textArea = document.createElement('textarea');
    textArea.value = AppState.coordsData;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
  }
  
  // M√∫ltiples m√©todos para abrir Sygic
  const sygicScheme = `com.sygic.aura://coordinate|${AppState.longitude}|${AppState.latitude}|show`;
  const sygicUniversal = `https://www.sygic.com/enter?longitude=${AppState.longitude}&latitude=${AppState.latitude}`;
  const appStoreUrl = 'https://apps.apple.com/app/sygic-gps-navigation/id585193266';
  
  // Intentar abrir con URL Scheme
  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src = sygicScheme;
  document.body.appendChild(iframe);
  
  // Verificar si se abri√≥
  setTimeout(() => {
    document.body.removeChild(iframe);
    
    // Si todav√≠a estamos en la p√°gina despu√©s de 500ms, intentar Universal Link
    setTimeout(() => {
      if (document.hasFocus()) {
        showToast('Intentando m√©todo alternativo...', 'info');
        window.location.href = sygicUniversal;
        
        // Si despu√©s de 1 segundo sigue sin funcionar, ofrecer App Store
        setTimeout(() => {
          if (document.hasFocus()) {
            const userConfirmed = confirm(
              'Sygic no est√° instalado en tu dispositivo.\n\n' +
              '¬øTe gustar√≠a instalar Sygic desde la App Store?\n\n' +
              'Coordenadas ya copiadas: ' + AppState.coordsData
            );
            
            if (userConfirmed) {
              window.open(appStoreUrl, '_blank');
              showToast('Redirigiendo a App Store...', 'info');
            } else {
              showToast('Coordenadas copiadas. Puedes pegarlas en cualquier app de mapas.', 'info');
            }
          }
        }, 1000);
      } else {
        showToast('Sygic abierto con las coordenadas', 'success');
      }
    }, 500);
  }, 100);
}

// ============ PROCESAMIENTO DE ARCHIVOS ============
async function processFile(file) {
  if (!CONFIG.SUPPORTED_FORMATS.includes(file.type)) {
    showToast('Formato no soportado. Usa JPG o PNG', 'error');
    playSound(150);
    return;
  }
  
  if (file.size > CONFIG.MAX_FILE_SIZE) {
    showToast('Archivo muy grande (m√°x. 5MB)', 'error');
    playSound(150);
    return;
  }
  
  showToast('Procesando imagen...', 'info');
  
  try {
    // Comprimir imagen
    const compressedFile = await compressImage(file);
    
    const imageUrl = URL.createObjectURL(compressedFile);
    DOM.preview.src = imageUrl;
    DOM.imgBox.classList.add('active');
    DOM.fileUploadArea.style.display = 'none';
    DOM.analyzeBtn.disabled = false;
    AppState.currentImage = imageUrl;
    AppState.originalFile = compressedFile;
    
    playSound(440);
    showToast('Imagen lista para escanear', 'success');
    
  } catch (error) {
    console.error('Error procesando imagen:', error);
    
    // Fallback
    const imageUrl = URL.createObjectURL(file);
    DOM.preview.src = imageUrl;
    DOM.imgBox.classList.add('active');
    DOM.fileUploadArea.style.display = 'none';
    DOM.analyzeBtn.disabled = false;
    AppState.currentImage = imageUrl;
    AppState.originalFile = file;
    
    showToast('Imagen cargada', 'info');
    playSound(440);
  }
}

// ============ AN√ÅLISIS CON VALIDACI√ìN ============
async function analyzeImage() {
  if (AppState.isProcessing) return;
  
  if (!DOM.preview.src || DOM.preview.src === window.location.href) {
    showToast('Primero carga una imagen', 'error');
    return;
  }
  
  AppState.isProcessing = true;
  DOM.analyzeBtn.disabled = true;
  DOM.analyzeBtn.querySelector('.btn-scan-text').innerHTML = '<div class="loader"></div> PROCESANDO...';
  DOM.status.textContent = '[ STATUS: ANALYZING... ]';
  DOM.status.className = 'status-processing';
  
  DOM.btnProgress.style.width = '0%';
  DOM.btnProgress.style.backgroundPosition = '0% 0%';
  
  DOM.imgBox.classList.add('scanning');
  playSound(880);
  
  try {
    const imageToProcess = AppState.originalFile 
      ? URL.createObjectURL(AppState.originalFile)
      : DOM.preview.src;
    
    const result = await Tesseract.recognize(
      imageToProcess, 
      CONFIG.TESSERACT_LANG,
      { logger: (m) => updateProgress(m) }
    );
    
    if (AppState.originalFile && imageToProcess !== DOM.preview.src) {
      URL.revokeObjectURL(imageToProcess);
    }
    
    const matches = result.data.text.match(CONFIG.COORD_REGEX);
    
    if (matches && matches.length > 0) {
      const coords = matches[0].replace(/[,\s]+/, ',').split(',');
      AppState.latitude = parseFloat(coords[0]);
      AppState.longitude = parseFloat(coords[1]);
      
      // VALIDACI√ìN DE COORDENADAS
      if (!isValidCoordinate(AppState.latitude, AppState.longitude)) {
        throw new Error('Coordenadas inv√°lidas detectadas');
      }
      
      AppState.coordsData = `${AppState.latitude}, ${AppState.longitude}`;
      
      DOM.btnProgress.style.width = '100%';
      DOM.btnProgress.style.backgroundPosition = '-200% 0%';
      
      displayResults();
      playSound(1200);
      if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
      showToast('‚úì Coordenadas v√°lidas detectadas', 'success');
    } else {
      throw new Error('No se encontraron coordenadas');
    }
    
  } catch (error) {
    DOM.status.textContent = '[ STATUS: ERROR ‚ùå ]';
    DOM.status.className = 'status-error';
    playSound(150);
    
    if (error.message.includes('inv√°lidas')) {
      showToast('Coordenadas inv√°lidas. Verifica la imagen.', 'error');
    } else {
      showToast('No se detectaron coordenadas', 'error');
    }
  } finally {
    DOM.imgBox.classList.remove('scanning');
    DOM.analyzeBtn.disabled = false;
    DOM.analyzeBtn.querySelector('.btn-scan-text').innerHTML = '<i class="fas fa-play"></i> INICIAR ESCANEO ü§ñ';
    AppState.isProcessing = false;
  }
}

// ============ MOSTRAR RESULTADOS FORMATEADOS ============
function displayResults() {
  const latFormatted = formatCoordinate(AppState.latitude, 'lat');
  const lonFormatted = formatCoordinate(AppState.longitude, 'lon');
  const formattedText = `${latFormatted}, ${lonFormatted}`;
  
  DOM.coordsText.textContent = formattedText;
  DOM.coordsText.style.display = 'block';
  DOM.resultPanel.style.display = 'block';
  DOM.actionButtons.style.display = 'grid';
  
  DOM.status.textContent = '[ STATUS: SUCCESS ‚úÖ ]';
  DOM.status.className = 'status-success';
}

// ============ RESET MEJORADO ============
function resetApp() {
  if (!confirm('¬øRestablecer toda la aplicaci√≥n?')) {
    return;
  }
  
  DOM.preview.src = '';
  DOM.imgBox.classList.remove('active');
  DOM.fileUploadArea.style.display = 'flex';
  DOM.resultPanel.style.display = 'none';
  DOM.actionButtons.style.display = 'none';
  DOM.analyzeBtn.disabled = true;
  
  DOM.btnProgress.style.width = '0%';
  DOM.btnProgress.style.backgroundPosition = '0% 0%';
  
  DOM.fileInput.value = '';
  DOM.status.textContent = '[ STATUS: STANDBY ]';
  DOM.status.className = 'status-standby';
  
  // Liberar recursos de memoria
  if (AppState.currentImage) {
    URL.revokeObjectURL(AppState.currentImage);
  }
  if (AppState.originalFile && AppState.originalFile !== AppState.currentImage) {
    URL.revokeObjectURL(URL.createObjectURL(AppState.originalFile));
  }
  
  // Resetear estado
  AppState.coordsData = "";
  AppState.latitude = 0;
  AppState.longitude = 0;
  AppState.isProcessing = false;
  AppState.currentImage = null;
  AppState.originalFile = null;
  
  playSound(300);
  showToast('Aplicaci√≥n reiniciada', 'info');
}
