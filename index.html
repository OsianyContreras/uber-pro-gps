<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Uber Pro GPS</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
/* --- Mantengo exactamente tu estilo (solo aÃ±adÃ­ estilos mÃ­nimos para fallback copy UI) --- */
body{ margin:0; padding:0; font-family:-apple-system, BlinkMacSystemFont, system-ui; background:radial-gradient(circle at top,#020617,#000); color:#fff; display:flex; justify-content:center; }
.card{ width:100%; max-width:420px; margin:16px; padding:18px; border-radius:20px; background:#020617; position:relative; box-shadow:0 0 0 1px rgba(148,163,184,.15), 0 30px 60px rgba(0,0,0,.7); animation:fadeIn .8s ease; }
.card::before{ content:""; position:absolute; inset:-2px; border-radius:22px; background:linear-gradient(120deg,#22c55e,#38bdf8,#22c55e); z-index:-1; animation:borderGlow 6s linear infinite; }
@keyframes borderGlow{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
h1{text-align:center;font-size:20px;margin-bottom:10px}
input[type=file]{width:100%;margin-top:10px}
img{width:100%;max-height:35vh;object-fit:contain;border-radius:14px;margin-top:12px;background:#000;}
button{width:100%;padding:15px;margin-top:12px;border-radius:14px;border:none;font-size:16px;font-weight:600;background:#22c55e;color:#000;}
button.secondary{background:#38bdf8}
button.gray{background:#64748b;color:#fff}
button:disabled{opacity:.4}
.status{margin-top:10px;font-size:14px;color:#94a3b8}
.coords{margin-top:10px;padding:10px;border-radius:12px;background:#020617;border:1px solid rgba(148,163,184,.15)}
.coords b{color:#22c55e;text-shadow:0 0 8px rgba(34,197,94,.6)}
.highlight{background:rgba(34,197,94,.15);padding:2px 6px;border-radius:6px}
.history{margin-top:12px;font-size:14px;color:#94a3b8}
#debug{margin-top:12px;font-size:12px;background:#000;padding:8px;border-radius:10px;max-height:120px;overflow:auto}
/* toast */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);background:#22c55e;color:#000;padding:10px 16px;border-radius:14px;font-size:14px;font-weight:600;opacity:0;pointer-events:none;transition:all .3s ease;box-shadow:0 10px 30px rgba(0,0,0,.6);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
/* fallback manual copy UI */
#manualCopyWrap{display:none;margin-top:10px;background:#081018;padding:10px;border-radius:8px;border:1px solid rgba(148,163,184,.06)}
#manualCoord{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(148,163,184,.08);background:#071018;color:#fff}
</style>
</head>
<body>
  <div class="card">
    <h1>ðŸš— Uber Pro GPS</h1>

    <input id="fileInput" type="file" accept="image/*">
    <img id="preview">

    <button id="analyzeBtn">Analizar Trayecto</button>

    <div class="status" id="status">Estado: esperando imagen</div>

    <div class="coords" id="coords">
      Latitud: â€”<br>Longitud: â€”
    </div>

    <button id="copyBtn" class="gray" disabled>ðŸ“‹ Copiar de nuevo</button>
    <button id="newQueryBtn" class="secondary" style="display:none">Nueva Consulta</button>

    <div id="manualCopyWrap">
      <div style="font-size:13px;color:#9ed7ff;margin-bottom:8px">Si la copia automÃ¡tica fallÃ³, usa este campo y pulsa Copiar:</div>
      <input id="manualCoord" readonly />
      <button id="manualCopyBtn" style="margin-top:8px">Copiar (manual)</button>
    </div>

    <div class="history" id="history"></div>
    <div id="debug"><b>DEBUG:</b><br></div>
  </div>

  <div id="toast" class="toast">ðŸ“‹ Coordenadas copiadas</div>

<script>
/* ----------------------- DOM ----------------------- */
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const analyzeBtn = document.getElementById('analyzeBtn');
const status = document.getElementById('status');
const coordsBox = document.getElementById('coords');
const debugBox = document.getElementById('debug');
const copyBtn = document.getElementById('copyBtn');
const newQueryBtn = document.getElementById('newQueryBtn');
const manualWrap = document.getElementById('manualCopyWrap');
const manualInput = document.getElementById('manualCoord');
const manualCopyBtn = document.getElementById('manualCopyBtn');
const toast = document.getElementById('toast');

let lat=null, lng=null, detectedProvider='â€”';
let worker = null;

/* ----------------------- helpers ----------------------- */
function debug(msg){ console.log(msg); debugBox.innerHTML += msg + "<br>"; debugBox.scrollTop = debugBox.scrollHeight; }
function showToast(){ toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1800); if(navigator.vibrate) navigator.vibrate(35); }

fileInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  preview.src = URL.createObjectURL(f);
  status.textContent = "Estado: Imagen preparada para OCR";
  debug("Imagen cargada");
  // reset UI
  copyBtn.disabled = true;
  newQueryBtn.style.display = "none";
  manualWrap.style.display = "none";
});

/* --------------------- robust OCR flow --------------------- */
async function initWorker(){
  if(worker) return worker;
  worker = await Tesseract.createWorker({
    logger: m => {
      // keep user informed
      if(m && m.status) debug('OCR: ' + m.status + (m.progress ? ` (${Math.round(m.progress*100)}%)` : ''));
    }
  });
  await worker.load();
  await worker.loadLanguage('eng+spa');
  await worker.initialize('eng+spa');
  return worker;
}

async function terminateWorker(){
  try{ if(worker) await worker.terminate(); }catch(e){ console.warn('worker terminate', e); }
  worker = null;
}

/* try copy using Clipboard API, fallback to execCommand, otherwise show manual field */
async function copyToClipboard(text){
  // first try modern API
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      debug('navigator.clipboard.writeText succeeded');
      return true;
    }
  }catch(err){
    debug('navigator.clipboard.writeText failed: ' + (err && err.message ? err.message : err));
  }

  // fallback: execCommand
  try{
    const ta = document.createElement('textarea');
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    debug('execCommand copy result: ' + ok);
    if(ok) return true;
  }catch(err){
    debug('execCommand failed: ' + (err && err.message ? err.message : err));
  }

  // last resort: show manual input with text selected so user can press copy
  manualInput.value = text;
  manualWrap.style.display = 'block';
  manualInput.focus();
  manualInput.select();
  debug('Mostrando fallback manual para copiar');
  return false;
}

/* --------------------- analyze handler --------------------- */
analyzeBtn.addEventListener('click', async () => {
  if(!fileInput.files[0]){
    status.innerHTML = '<span style="color:#ffb3b3">Primero carga una imagen</span>';
    return;
  }

  status.textContent = 'Estado: OCR en procesoâ€¦';
  debug('Iniciando OCR');

  try{
    // init worker
    await initWorker();

    // recognize from file (key: pass file object, not blob url)
    const result = await worker.recognize(fileInput.files[0]);
    const text = result?.data?.text || '';
    debug('Texto OCR capturado: ' + (text.slice(0,200) || '(vacÃ­o)'));

    // detect provider
    if(/uber/i.test(text)) detectedProvider = 'Uber';
    else if(/didi/i.test(text)) detectedProvider = 'Didi';
    else detectedProvider = 'â€”';

    // extract up to two coords using robust regex
    const re = /(-?\d{1,2}\.\d{4,})\s*,\s*(-?\d{1,3}\.\d{4,})/g;
    const matches = [...text.matchAll(re)].slice(0,2);
    if(matches.length === 0){
      // try looser regex if none found
      const re2 = /(-?\d{1,2}\.\d+)\s*[,\s]\s*(-?\d{1,3}\.\d+)/g;
      const m2 = [...text.matchAll(re2)].slice(0,2);
      if(m2.length) {
        matches.push(...m2);
      }
    }

    if(matches.length >= 1){
      lat = Number(matches[0][1]).toFixed(6);
      lng = Number(matches[0][2]).toFixed(6);
      coordsBox.innerHTML = `Latitud: <span class="highlight"><b>${lat}</b></span><br>Longitud: <span class="highlight"><b>${lng}</b></span>`;
    }

    if(matches.length >= 2){
      // If a second coord exists, we could show pickup/dropoff; currently we show primary only
      debug('Encontradas 2 coordenadas (se mostrÃ³ la primera).');
    }

    if(!lat || !lng){
      throw new Error('No se detectaron coordenadas en el OCR');
    }

    // Try to copy to clipboard (robust)
    const coordsText = `${lat},${lng}`;
    const copied = await copyToClipboard(coordsText);

    if(copied){
      debug('Coordenadas copiadas: ' + coordsText);
      showToast();
    } else {
      debug('Copia automÃ¡tica NO disponible, muestra UI manual');
      // manual input is visible already
    }

    // enable buttons
    copyBtn.disabled = false;
    newQueryBtn.style.display = 'block';
    status.innerHTML = '<span style="color:#9ef0c1">Coordenadas detectadas</span>';

    // Don't auto-open Sygic here â€” user preferred to paste manually into Sygic.
    // If you still want auto-open, uncomment the next lines (but may be blocked by Safari):
    // tryOpenSygicAuto(lat, lng);

  }catch(err){
    console.error('OCR error', err);
    debug('ERROR OCR: ' + (err && err.message ? err.message : err));
    status.innerHTML = '<span style="color:#ffb3b3">Error al procesar la imagen â€” usar entrada manual</span>';
    manualWrap.style.display = 'block';
  }finally{
    // always terminate worker to free memory
    try{ await terminateWorker(); }catch(e){/* ignore */ }
  }
});

/* --------------------- manual copy button (user gesture) --------------------- */
manualCopyBtn.addEventListener('click', async () => {
  const txt = manualInput.value;
  if(!txt) return;
  try{
    await navigator.clipboard.writeText(txt);
    debug('Manual copy via navigator.clipboard succeeded');
    showToast();
  }catch(err){
    // fallback to execCommand
    const ok = document.execCommand && (function(){
      const ta = document.createElement('textarea');
      ta.style.position='fixed'; ta.style.left='-9999px'; ta.value = txt;
      document.body.appendChild(ta); ta.select();
      const res = document.execCommand('copy'); document.body.removeChild(ta);
      return res;
    })();
    debug('Manual execCommand copy result: ' + ok);
    if(ok) showToast();
    else alert('No fue posible copiar automÃ¡ticamente. Selecciona y copia manualmente el texto mostrado.');
  }
});

/* --------------------- copy again button --------------------- */
copyBtn.addEventListener('click', async ()=>{
  if(!lat || !lng) return;
  const txt = `${lat},${lng}`;
  const ok = await copyToClipboard(txt);
  if(ok){ showToast(); debug('Copiado via copyBtn: ' + txt); }
});

/* --------------------- new query --------------------- */
newQueryBtn.addEventListener('click', ()=>{
  fileInput.value = '';
  preview.src = '';
  coordsBox.innerHTML = `Latitud: â€”<br>Longitud: â€”`;
  status.textContent = 'Estado: esperando imagen';
  copyBtn.disabled = true;
  newQueryBtn.style.display = 'none';
  manualWrap.style.display = 'none';
  manualInput.value = '';
  lat = lng = null; detectedProvider='â€”';
  debug('Nueva consulta iniciada (limpieza)');
});

/* --------------------- history (simple) --------------------- */
function saveHistory(value){
  try{
    const arr = JSON.parse(localStorage.getItem('historial')||'[]');
    arr.unshift({ when: new Date().toLocaleString(), value });
    localStorage.setItem('historial', JSON.stringify(arr.slice(0,20)));
    renderHistory();
  }catch(e){ debug('History error: '+e); }
}
function renderHistory(){
  const arr = JSON.parse(localStorage.getItem('historial')||'[]');
  const box = document.getElementById('history');
  box.innerHTML = "<b>Historial:</b><br>" + arr.map(x=>`â€¢ ${x.when} â€” ${x.value}`).join("<br>");
}
renderHistory();
</script>
</body>
</html>
